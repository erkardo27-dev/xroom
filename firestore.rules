
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if the user is the owner of a document
    function isOwner(docOwnerId) {
      return request.auth != null && request.auth.uid == docOwnerId;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             (request.auth.token.email == "erkardo27@gmail.com" || 
              request.auth.token.email == "bayarkhuu@xroom.mn");
    }

    // Hotels collection: Contains public information about each hotel,
    // but can only be written to by the owner.
    match /hotels/{hotelId} {
      // Anyone can read hotel information
      allow read: if true;
      
      // Only the authenticated owner can create, update or delete their hotel info.
      // The hotel document ID must match the user's UID.
      allow write: if isOwner(hotelId) || isAdmin();
    }
    
    // Room Types collection: Contains templates for room types.
    match /room_types/{roomTypeId} {
      // Anyone can read room type information.
      allow read: if true;
      
      // Only the owner can write to their own room types.
      allow create: if isOwner(request.resource.data.ownerId) || isAdmin();
      allow update, delete: if isOwner(resource.data.ownerId) || isAdmin();
    }
    
    // Room Instances collection: Represents physical rooms.
    match /room_instances/{instanceId} {
      // Anyone can read available rooms.
      // Owners can read all their own room instances.
      allow read: if resource.data.status == 'available' || isOwner(resource.data.ownerId) || isAdmin();
      
      // The owner or admin can update their own room instances.
      allow update: if isOwner(resource.data.ownerId) || isAdmin();

      // A special case for booking: Anyone can update a room instance
      // to book it if it is currently available.
      // Note: In a real system, this would be handled via a secure Server Action/Function
      // to prevent race conditions and ensure payment.
      allow update: if resource.data.status == 'available' && 
                      request.resource.data.status == 'booked' &&
                      request.resource.data.ownerId == resource.data.ownerId;

      // Only the owner or admin can create or delete room instances.
      allow create: if isOwner(request.resource.data.ownerId) || isAdmin();
      allow delete: if isOwner(resource.data.ownerId) || isAdmin();
    }
  }
}
