
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if the user is the owner of a document
    function isOwner(docOwnerId) {
      return request.auth != null && request.auth.uid == docOwnerId;
    }

    // Hotels collection: Contains public information about each hotel,
    // but can only be written to by the owner.
    match /hotels/{hotelId} {
      // Anyone can read hotel information
      allow read: if true;
      
      // Only the authenticated owner can create, update or delete their hotel info.
      // The hotel document ID must match the user's UID.
      allow write: if isOwner(hotelId);
    }
    
    // Room Types collection: Contains templates for room types.
    match /room_types/{roomTypeId} {
      // Anyone can read room type information.
      allow read: if true;
      
      // Only the owner can write to their own room types.
      allow write: if isOwner(request.resource.data.ownerId);
    }
    
    // Room Instances collection: Represents physical rooms.
    match /room_instances/{instanceId} {
      // Anyone can read room instance data to see availability.
      allow read: if true;
      
      // The owner can update their own room instances (e.g. room number, initial status).
      allow update: if isOwner(request.resource.data.ownerId);

      // Only the owner can create or delete room instances.
      allow create, delete: if isOwner(request.resource.data.ownerId);
      
      // A special case for booking: Any authenticated user can update a room instance
      // to book it, but ONLY if they are changing the status to 'booked' and not
      // overwriting an existing booking. This is a simplified rule for the MVP.
      // A more robust solution would use a transaction and a separate 'bookings' collection.
      allow update: if request.auth != null &&
                      request.resource.data.overrides[request.time.date().toString()].status == 'booked' &&
                      (!resource.data.overrides.keys().hasAny([request.time.date().toString()])) ||
                      (resource.data.overrides[request.time.date().toString()].status != 'booked');
    }
  }
}
